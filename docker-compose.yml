version: '3.8'

services:
  nginx:
    image: nginx:alpine
    container_name: nginx_gestor
    ports:
      - '${APP_PORT:-8077}:80'
      - '${APP_PORT_SSL:-5445}:443'
    volumes:
      - .:/var/www/html
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./docker/ssl:/etc/nginx/ssl
    depends_on:
      - php
      - node
    networks:
      - laravel
    restart: always

  php:
      build:
          context: .
          dockerfile: docker/php/Dockerfile
      container_name: php_gestor
      restart: always
      working_dir: /var/www/html
      volumes:
          - .:/var/www/html
          - ./storage:/var/www/html/storage
          - ./bootstrap/cache:/var/www/html/bootstrap/cache
      networks:
          - laravel
      environment:
          - APP_ENV=${APP_ENV}
          - APP_DEBUG=${APP_DEBUG}
          - APP_KEY=${APP_KEY}
      user: "www-data"
      command: sh -c "php -v && php-fpm"

  db:
    image: mysql:8.0
    container_name: mysql_gestor
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    ports:
      - "3366:3306"
    volumes:
      - db_data:/var/lib/mysql
    restart: always
    networks:
      - laravel

    # âœ… SEGUNDA BASE DE DATOS
  db2:
    image: mysql:8.0
    container_name: mysql_camionerosg
    environment:
      MYSQL_DATABASE: ${DB2_DATABASE}
      MYSQL_USER: ${DB2_USERNAME}
      MYSQL_PASSWORD: ${DB2_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB2_ROOT_PASSWORD}
    ports:
      - "3367:3306"     # puerto externo distinto
    volumes:
      - db2_data:/var/lib/mysql
    restart: always
    networks:
      - laravel

  db3:
      image: mysql:8.0
      container_name: mysql_defaultg
      environment:
          MYSQL_DATABASE: ${DB3_DATABASE}
          MYSQL_USER: ${DB3_USERNAME}
          MYSQL_PASSWORD: ${DB3_PASSWORD}
          MYSQL_ROOT_PASSWORD: ${DB3_ROOT_PASSWORD}
      ports:
          - "3368:3306"     # puerto externo distinto
      volumes:
          - db3_data:/var/lib/mysql
      restart: always
      networks:
          - laravel

  db4:
      image: mysql:8.0
      container_name: mysql_plutong
      environment:
          MYSQL_DATABASE: ${DB4_DATABASE}
          MYSQL_USER: ${DB4_USERNAME}
          MYSQL_PASSWORD: ${DB4_PASSWORD}
          MYSQL_ROOT_PASSWORD: ${DB4_ROOT_PASSWORD}
      ports:
          - "3369:3306"     # puerto externo distinto
      volumes:
          - db4_data:/var/lib/mysql
      restart: always
      networks:
          - laravel

  db5:
      image: mysql:8.0
      container_name: mysql_buscadorg
      environment:
          MYSQL_DATABASE: ${DB5_DATABASE}
          MYSQL_USER: ${DB5_USERNAME}
          MYSQL_PASSWORD: ${DB5_PASSWORD}
          MYSQL_ROOT_PASSWORD: ${DB5_ROOT_PASSWORD}
      ports:
          - "3370:3306"     # puerto externo distinto
      volumes:
          - db5_data:/var/lib/mysql
      restart: always
      networks:
          - laravel

  db6:
      image: mysql:8.0
      container_name: mysql_cronosg
      environment:
          MYSQL_DATABASE: ${DB6_DATABASE}
          MYSQL_USER: ${DB6_USERNAME}
          MYSQL_PASSWORD: ${DB6_PASSWORD}
          MYSQL_ROOT_PASSWORD: ${DB6_ROOT_PASSWORD}
      ports:
          - "3371:3306"     # puerto externo distinto
      volumes:
          - db6_data:/var/lib/mysql
      restart: always
      networks:
          - laravel

  db7:
      image: mysql:8.0
      container_name: mysql_storeg
      environment:
          MYSQL_DATABASE: ${DB7_DATABASE}
          MYSQL_USER: ${DB7_USERNAME}
          MYSQL_PASSWORD: ${DB7_PASSWORD}
          MYSQL_ROOT_PASSWORD: ${DB7_ROOT_PASSWORD}
      ports:
          - "3372:3306"     # puerto externo distinto
      volumes:
          - db7_data:/var/lib/mysql
      restart: always
      networks:
          - laravel

  db8:
      image: mysql:8.0
      container_name: mysql_zeusg
      environment:
          MYSQL_DATABASE: ${DB8_DATABASE}
          MYSQL_USER: ${DB8_USERNAME}
          MYSQL_PASSWORD: ${DB8_PASSWORD}
          MYSQL_ROOT_PASSWORD: ${DB8_ROOT_PASSWORD}
      ports:
          - "3373:3306"     # puerto externo distinto
      volumes:
          - db8_data:/var/lib/mysql
      restart: always
      networks:
          - laravel

  db9:
      image: mysql:8.0
      container_name: mysql_semillasg
      environment:
          MYSQL_DATABASE: ${DB9_DATABASE}
          MYSQL_USER: ${DB9_USERNAME}
          MYSQL_PASSWORD: ${DB9_PASSWORD}
          MYSQL_ROOT_PASSWORD: ${DB9_ROOT_PASSWORD}
      ports:
          - "3374:3306"     # puerto externo distinto
      volumes:
          - db9_data:/var/lib/mysql
      restart: always
      networks:
          - laravel

  db10:
      image: mysql:8.0
      container_name: mysql_trabajadoresg
      environment:
          MYSQL_DATABASE: ${DB10_DATABASE}
          MYSQL_USER: ${DB10_USERNAME}
          MYSQL_PASSWORD: ${DB10_PASSWORD}
          MYSQL_ROOT_PASSWORD: ${DB10_ROOT_PASSWORD}
      ports:
          - "3375:3306"     # puerto externo distinto
      volumes:
          - db10_data:/var/lib/mysql
      restart: always
      networks:
          - laravel

  node:
    image: node:22-alpine
    container_name: node_gestor
    working_dir: /var/www/html
    volumes:
      - .:/var/www/html:delegated
      - node_modules:/var/www/html/node_modules
    environment:
      - APP_ENV=${APP_ENV}
    command: >
      sh -c "
      echo 'El valor de APP_ENV es: ${APP_ENV}' &&
      npm install &&
      if [ '${APP_ENV}' = 'production' ]; then
        npm run build;
      else
        npm run dev;
      fi"
    networks:
      - laravel
    restart: always

networks:
  laravel:

volumes:
  storage:
    driver: local
  cache:
    driver: local
  node_modules:
    driver: local
  db_data:
    driver: local
  db2_data:
    driver: local
  db3_data:
      driver: local
  db4_data:
      driver: local
  db5_data:
      driver: local
  db6_data:
      driver: local
  db7_data:
      driver: local
  db8_data:
      driver: local
  db9_data:
      driver: local
  db10_data:
      driver: local
